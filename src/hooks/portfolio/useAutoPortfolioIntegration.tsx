
import { useEffect, useState } from "react";
import { useUniversalPortfolio, UniversalActivityData } from "./useUniversalPortfolio";
import { useTimeEntries } from "@/hooks/time-tracking/useTimeEntries";

export const useAutoPortfolioIntegration = () => {
  const { createUniversalPortfolioEntry, convertTimeEntryToUniversal } = useUniversalPortfolio();
  const { entries: timeEntries } = useTimeEntries();
  const [autoSyncEnabled, setAutoSyncEnabled] = useState(true);
  const [lastSyncTimestamp, setLastSyncTimestamp] = useState<string | null>(null);

  // Auto-sync new activities to portfolio
  useEffect(() => {
    if (!autoSyncEnabled) return;

    const syncNewActivities = async () => {
      const syncTimestamp = localStorage.getItem('portfolio_last_sync');
      const newTimeEntries = timeEntries.filter(entry => {
        if (!syncTimestamp) return true;
        return new Date(entry.date).getTime() > new Date(syncTimestamp).getTime();
      });

      // Process new time entries
      for (const timeEntry of newTimeEntries) {
        // Skip if already processed
        const processedEntries = JSON.parse(localStorage.getItem('processed_portfolio_entries') || '[]');
        if (processedEntries.includes(timeEntry.id)) continue;

        try {
          const universalActivity = convertTimeEntryToUniversal(timeEntry);
          await createUniversalPortfolioEntry({
            ...universalActivity,
            autoGenerated: true
          });

          // Mark as processed
          processedEntries.push(timeEntry.id);
          localStorage.setItem('processed_portfolio_entries', JSON.stringify(processedEntries));
        } catch (error) {
          console.error('Failed to auto-sync activity:', error);
        }
      }

      // Update sync timestamp
      const currentTimestamp = new Date().toISOString();
      localStorage.setItem('portfolio_last_sync', currentTimestamp);
      setLastSyncTimestamp(currentTimestamp);
    };

    syncNewActivities();
  }, [timeEntries, autoSyncEnabled, createUniversalPortfolioEntry, convertTimeEntryToUniversal]);

  // Manual sync function for specific activities
  const syncActivityToPortfolio = async (activityData: UniversalActivityData) => {
    try {
      return await createUniversalPortfolioEntry(activityData);
    } catch (error) {
      console.error('Failed to sync activity to portfolio:', error);
      throw error;
    }
  };

  // Sync study session activity
  const syncStudySession = async (sessionData: {
    title: string;
    content: string;
    duration: number;
    completedAt: string;
  }) => {
    const activityData: UniversalActivityData = {
      title: `Study Session: ${sessionData.title}`,
      description: `Completed study of ${sessionData.content}`,
      activityType: 'study-session',
      timeSpent: sessionData.duration,
      date: sessionData.completedAt,
      skills: ['Self-Directed Learning', 'Knowledge Acquisition']
    };

    return await syncActivityToPortfolio(activityData);
  };

  // Sync quiz completion
  const syncQuizCompletion = async (quizData: {
    title: string;
    score: number;
    totalQuestions: number;
    duration: number;
    completedAt: string;
    topics: string[];
  }) => {
    const scorePercentage = Math.round((quizData.score / quizData.totalQuestions) * 100);
    
    const activityData: UniversalActivityData = {
      title: `Quiz: ${quizData.title}`,
      description: `Completed quiz with ${scorePercentage}% score (${quizData.score}/${quizData.totalQuestions}). Topics covered: ${quizData.topics.join(', ')}`,
      activityType: 'quiz',
      timeSpent: quizData.duration,
      date: quizData.completedAt,
      skills: ['Knowledge Assessment', 'Self-Evaluation', ...quizData.topics.slice(0, 3)],
      sourceData: quizData
    };

    return await syncActivityToPortfolio(activityData);
  };

  // Sync evidence upload
  const syncEvidenceUpload = async (evidenceData: {
    title: string;
    type: string;
    description: string;
    uploadedAt: string;
  }) => {
    const activityData: UniversalActivityData = {
      title: `Evidence: ${evidenceData.title}`,
      description: `Uploaded ${evidenceData.type} evidence: ${evidenceData.description}`,
      activityType: 'evidence',
      timeSpent: 15, // Estimated time for evidence preparation
      date: evidenceData.uploadedAt,
      skills: ['Documentation', 'Evidence Management']
    };

    return await syncActivityToPortfolio(activityData);
  };

  return {
    autoSyncEnabled,
    setAutoSyncEnabled,
    lastSyncTimestamp,
    syncActivityToPortfolio,
    syncStudySession,
    syncQuizCompletion,
    syncEvidenceUpload
  };
};
