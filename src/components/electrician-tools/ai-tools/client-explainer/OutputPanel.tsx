import { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Copy, Download, Mail, MessageSquare, FileText, Printer, Share } from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import { generateProfessionalElectricalPDF } from '@/utils/professional-electrical-pdf';

interface OutputPanelProps {
  content: string;
  settings: {
    tone: string;
    readingLevel: string;
    clientType: string;
    includeAnalogy: boolean;
    emphasizeSafety: boolean;
    includeCostInfo: boolean;
  };
}

const OutputPanel = ({ content, settings }: OutputPanelProps) => {
  const { toast } = useToast();
  const [isGeneratingPDF, setIsGeneratingPDF] = useState(false);

  // Process content for better mobile rendering
  const processContentForDisplay = (text: string) => {
    if (!text) return text;
    
    // Clean the text first
    let cleanText = text
      .replace(/\s+/g, ' ')
      .trim();

    // Split into paragraphs
    const paragraphs = cleanText.split(/\n\n+/);
    
    return paragraphs.map(paragraph => {
      let formatted = paragraph.trim();
      
      // Check if it's a heading (ends with colon or is short and caps)
      if (formatted.endsWith(':') || (formatted.length < 50 && formatted === formatted.toUpperCase())) {
        return `<h3 class="text-xl font-bold text-foreground mb-6 mt-8 first:mt-0">${formatted}</h3>`;
      }
      
      // Format special terms
      formatted = formatted
        .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
        .replace(/\*(.*?)\*/g, '<em class="italic">$1</em>')
        .replace(/BS 7671/g, '<span class="text-elec-yellow font-medium">BS 7671</span>')
        .replace(/(\d{3}\.\d+\.\d+)/g, '<span class="text-blue-400 font-mono">$1</span>')
        .replace(/(C[123]|FI)/g, '<span class="px-2 py-1 rounded bg-red-500/20 text-red-400 text-sm font-semibold">$1</span>');
      
      // Split long paragraphs into sentences for better readability
      const sentences = formatted.split(/\. (?=[A-Z])/);
      
      if (sentences.length > 2) {
        // Create bullet points for multiple sentences
        return '<ul class="space-y-4 mb-8 ml-0 list-none">' + 
          sentences.map(sentence => {
            const clean = sentence.trim();
            if (!clean) return '';
            const withPeriod = clean.endsWith('.') ? clean : clean + '.';
            return `<li class="text-foreground leading-loose pl-6 relative before:content-['â€¢'] before:absolute before:left-0 before:text-elec-yellow before:font-bold">${withPeriod}</li>`;
          }).filter(s => s).join('') + 
        '</ul>';
      } else {
        // Keep as paragraph for short content
        return `<p class="text-foreground leading-loose mb-6 text-base">${formatted}</p>`;
      }
    }).join('');
  };

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(content);
      toast({
        title: "Copied",
        description: "Explanation copied to clipboard",
        variant: "success"
      });
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to copy to clipboard",
        variant: "destructive"
      });
    }
  };

  const handleDownloadTxt = () => {
    const element = document.createElement('a');
    const file = new Blob([content], { type: 'text/plain' });
    element.href = URL.createObjectURL(file);
    element.download = 'client-explanation.txt';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
  };

  const handleDownloadPDF = async () => {
    setIsGeneratingPDF(true);
    try {
      // Format content for professional PDF generation
      const formattedContent = `
# Client Explanation Document

**Generated Settings:**
- **Tone:** ${settings.tone}
- **Reading Level:** ${settings.readingLevel}
- **Client Type:** ${settings.clientType}

---

## Explanation Content

${content}

---

*Generated by ElecConnect AI Client Explainer Tool*
*Date: ${new Date().toLocaleDateString('en-GB')}*
      `;
      
      await generateProfessionalElectricalPDF(formattedContent, "Client Explanation", 'client-explanation.pdf', {
        reportType: "Client Explanation",
        companyName: "ElecConnect Professional",
        includeSignatures: false,
        watermark: "CLIENT COMMUNICATION"
      });
      
      toast({
        title: "Success",
        description: "Professional PDF downloaded successfully",
        variant: "success"
      });
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to generate professional PDF",
        variant: "destructive"
      });
    } finally {
      setIsGeneratingPDF(false);
    }
  };

  const handleEmailTemplate = () => {
    const subject = encodeURIComponent("Electrical Work Explanation");
    const body = encodeURIComponent(`Dear Client,\n\nPlease find below the explanation of the electrical work findings:\n\n${content}\n\nBest regards,\nYour Electrician`);
    window.open(`mailto:?subject=${subject}&body=${body}`);
  };

  const handleSMSTemplate = () => {
    const smsContent = content.length > 160 ? content.substring(0, 157) + "..." : content;
    const smsBody = encodeURIComponent(`Hi, regarding your electrical work: ${smsContent}`);
    window.open(`sms:?body=${smsBody}`);
  };

  const formatForEmail = (content: string) => {
    // Clean content by removing all markdown formatting
    const cleanContent = content
      .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold markers
      .replace(/\*(.*?)\*/g, '$1') // Remove italic markers
      .replace(/#{1,6}\s/g, '') // Remove heading markers
      .replace(/[-*+]\s/g, '') // Remove bullet points
      .replace(/\n\s*\n/g, '\n\n') // Clean up extra line breaks
      .trim();

    return `Dear Valued Client,

I hope this email finds you well. I wanted to provide you with a clear explanation of the electrical work findings from my recent inspection of your property.

Electrical Inspection Summary:

${cleanContent}

Next Steps:
If you have any questions about these findings or would like to discuss the recommended work, please don't hesitate to contact me. I'm here to ensure your electrical system is safe and compliant with current regulations.

Thank you for trusting me with your electrical needs. I look forward to hearing from you soon.

Best regards,

[Your Name]
Qualified Electrician
[Your Contact Details]
[Your Company Name]`;
  };

  const formatForSMS = (content: string) => {
    // SMS version - much shorter
    const shortContent = content.split('.')[0] + '.';
    return `Hi! Quick update on your electrical work: ${shortContent} Call me for more details.`;
  };

  const formatForQuote = (content: string) => {
    return `ELECTRICAL WORK EXPLANATION

${content}

This explanation accompanies our quotation and outlines the work required to address the findings detailed above.

Next Steps:
1. Review this explanation
2. Contact us with any questions
3. Approve the quotation to proceed

Thank you for choosing our electrical services.`;
  };

  return (
    <Card className="mobile-card border-border/50 bg-card/50">
      <CardHeader className="mobile-padding pb-3">
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div className="flex items-center space-x-2">
            <MessageSquare className="h-5 w-5 text-elec-yellow" />
            <CardTitle className="mobile-heading text-foreground">Client Explanation</CardTitle>
          </div>
          {content && (
            <div className="flex gap-2 w-full sm:w-auto">
              <Button
                variant="outline"
                size="sm"
                onClick={handleCopy}
                className="mobile-button-secondary flex-1 sm:flex-none touch-target border-border/50 hover:bg-card text-foreground"
              >
                <Copy className="h-4 w-4 mr-1" />
                Copy
              </Button>
              <Button
                variant="outline"
                size="sm"
                onClick={handleDownloadPDF}
                disabled={isGeneratingPDF}
                className="mobile-button-secondary flex-1 sm:flex-none touch-target border-border/50 hover:bg-card text-foreground"
              >
                <Download className="h-4 w-4 mr-1" />
                {isGeneratingPDF ? "Creating..." : "PDF"}
              </Button>
            </div>
          )}
        </div>
      </CardHeader>
      <CardContent className="mobile-padding space-y-4">
        {content ? (
          <>
            {/* Output formats */}
            <Tabs defaultValue="standard" className="w-full">
              <TabsList className="mobile-grid-responsive grid w-full grid-cols-2 sm:grid-cols-4 h-auto">
                <TabsTrigger value="standard" className="mobile-tap-highlight touch-target text-xs sm:text-sm">
                  Explanation
                </TabsTrigger>
                <TabsTrigger value="email" className="mobile-tap-highlight touch-target text-xs sm:text-sm">
                  Email
                </TabsTrigger>
                <TabsTrigger value="sms" className="mobile-tap-highlight touch-target text-xs sm:text-sm">
                  Text/SMS
                </TabsTrigger>
                <TabsTrigger value="quote" className="mobile-tap-highlight touch-target text-xs sm:text-sm">
                  Quote
                </TabsTrigger>
              </TabsList>
              
              <TabsContent value="standard" className="mt-4">
                <div className="mobile-card bg-muted/30 border border-border/50 rounded-lg p-6">
                  <div 
                    className="text-left max-w-none text-foreground"
                    style={{ 
                      fontSize: '15px',
                      lineHeight: '1.7',
                      fontFamily: 'system-ui, -apple-system, sans-serif'
                    }}
                    dangerouslySetInnerHTML={{ 
                      __html: processContentForDisplay(content)
                    }}
                  />
                </div>
              </TabsContent>
              
              <TabsContent value="email" className="mt-4">
                <div className="space-y-3">
                  <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
                    <h4 className="mobile-small-text font-medium text-foreground">Email Template</h4>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={handleEmailTemplate}
                      className="mobile-button-secondary touch-target w-full sm:w-auto"
                    >
                      <Mail className="h-4 w-4 mr-1" />
                      Open in Email App
                    </Button>
                  </div>
                  <div className="mobile-card bg-muted/30 border border-border/50 rounded-lg p-6">
                    <div 
                      className="text-left max-w-none text-foreground"
                      style={{ 
                        fontSize: '15px',
                        lineHeight: '1.7',
                        fontFamily: 'system-ui, -apple-system, sans-serif'
                      }}
                    >
                      {formatForEmail(content).split('\n').map((line, index) => (
                        <p key={index} className="mb-4 leading-relaxed text-foreground">{line}</p>
                      ))}
                    </div>
                  </div>
                </div>
              </TabsContent>
              
              <TabsContent value="sms" className="mt-4">
                <div className="space-y-3">
                  <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
                    <h4 className="mobile-small-text font-medium text-foreground">Text Message Version</h4>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={handleSMSTemplate}
                      className="mobile-button-secondary touch-target w-full sm:w-auto"
                    >
                      <MessageSquare className="h-4 w-4 mr-1" />
                      Send Text Message
                    </Button>
                  </div>
                  <div className="mobile-card bg-muted/30 border border-border/50 rounded-lg p-6">
                    <div 
                      className="text-foreground leading-7"
                      style={{ 
                        fontSize: '15px',
                        lineHeight: '1.7',
                        fontFamily: 'system-ui, -apple-system, sans-serif'
                      }}
                    >
                      {formatForSMS(content)}
                    </div>
                    <div className="mt-3 text-xs text-foreground bg-muted/20 rounded px-2 py-1">
                      Characters: {formatForSMS(content).length}/160
                    </div>
                  </div>
                </div>
              </TabsContent>
              
              <TabsContent value="quote" className="mt-4">
                <div className="space-y-3">
                  <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
                    <h4 className="mobile-small-text font-medium text-foreground">Quotation Format</h4>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={handleDownloadTxt}
                      className="mobile-button-secondary touch-target w-full sm:w-auto"
                    >
                      <FileText className="h-4 w-4 mr-1" />
                      Download Document
                    </Button>
                  </div>
                  <div className="mobile-card bg-muted/30 border border-border/50 rounded-lg p-6">
                    <div 
                      className="text-left max-w-none text-foreground"
                      style={{ 
                        fontSize: '15px',
                        lineHeight: '1.7',
                        fontFamily: 'system-ui, -apple-system, sans-serif'
                      }}
                      dangerouslySetInnerHTML={{ 
                        __html: processContentForDisplay(formatForQuote(content))
                      }}
                    />
                  </div>
                </div>
              </TabsContent>
            </Tabs>
          </>
        ) : (
          <div className="mobile-card bg-muted/30 border border-border/50 rounded-lg p-8 text-center">
            <MessageSquare className="h-12 w-12 text-foreground/50 mx-auto mb-4" />
            <div className="space-y-2">
              <p className="mobile-text text-foreground">
                Your client-friendly explanation will appear here
              </p>
              <p className="mobile-small-text text-foreground/70">
                Available in multiple formats: standard explanation, email template, text message, and quotation format
              </p>
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
};

export default OutputPanel;